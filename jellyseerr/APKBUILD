pkgname=seerr
pkgver=2.7.3
pkgrel=0
pkgdesc="Plex/Emby/Jellyfin request management system (Next-Gen Overseerr fork)"
url="https://github.com/seerr-team/seerr"
arch="x86_64"
license="MIT"
depends="nodejs"
makedepends="nodejs npm git python3 make linux-headers"
subpackages="$pkgname-openrc::x86_64"
source="$pkgname-$pkgver.tar.gz::https://github.com/seerr-team/seerr/archive/refs/tags/v$pkgver.tar.gz
        seerr.initd
        seerr.confd
        seerr.wrapper
       "
       
pkgusers="seerr"
pkggroups="seerr"
options="!check !tracedeps"

build() {
    npm install --prefix "$srcdir/npm-tmp" pnpm@9
    export PATH="$srcdir/npm-tmp/node_modules/.bin:$PATH"

    cd "$builddir"
    export NEXT_TELEMETRY_DISABLED=1
    export CYPRESS_INSTALL_BINARY=0
    
    pnpm install --frozen-lockfile 
    pnpm build

    rm -rf node_modules
    
    pnpm install --prod --ignore-scripts --frozen-lockfile --no-optional
    pnpm store prune                 
    rm -rf src server charts gen-docs docs .next/cache

    find node_modules -type f \( -name '*.md' -o -name '*.ts' -o -name '*.tsx' -o -name 'LICENSE*' -o -name 'CHANGELOG*' -o -name 'README*' \) -delete
    find node_modules -type d \( -name test -o -name tests -o -name docs -o -name examples -o -name coverage -o -name '.github' \) -exec rm -rf {} + 2>/dev/null || true
}

package() {
    local app_dir="$pkgdir/usr/lib/$pkgname"
    
    install -dm755 "$app_dir"
    install -dm755 "$pkgdir/var/lib/seerr"
    install -dm755 "$pkgdir/var/log/seerr"
    install -dm755 "$pkgdir/etc/seerr"

    cp -a .next dist public node_modules \
          package.json jellyseerr-api.yml next.config.js \
          "$app_dir/"

    rm -rf "$app_dir/.next/cache"
    find "$app_dir" -name '*.map' -type f -delete

    find "$app_dir/node_modules" \
        \( -path '*/sharp/**' -o -path '*/ffmpeg-static/**' \) \
        ! -path '*linux-x64-musl*' -type f -delete
    
    install -Dm755 "$srcdir/$pkgname.wrapper" "$pkgdir/usr/bin/seerr"
    install -Dm755 "$srcdir/$pkgname.initd"   "$pkgdir/etc/init.d/$pkgname"
    install -Dm644 "$srcdir/$pkgname.confd"   "$pkgdir/etc/conf.d/$pkgname"
}

sha512sums="
d27d49fa11a7b30ec1693b23e23fe7a93613d901f99de6d24de658bb7fd2bc13db957ae1c0f98a1e0ef709b923736f65cecd2ae22144ffe26f1dbee1b830f5b2  seerr-2.7.3.tar.gz
e73b5f83092d0f014057672b31e5cdbe1a4b85c28ab4d965947c2b39470427d3c51dfbcf7a8bebd92b2afbaea69cb8030cab0c60ab1d7dcebaf9df6de36fb143  seerr.initd
9d5ebc45d18268bcec2d0ec48b9d86538f236d2ff8845b081691176cd0689bf6b521e244b0ce27fc3aefd569bfc7c2d4b8827d7cc4043bd9ffe8660d3bdce061  seerr.confd
20dd1613d2d4e3a3286e2779e5bfcb22f97d56f27e9ae9bd45791a9676cb4f9959e4f5a19ea73cc8fa055b5181ec778f97e723c995dfde049a11747e68e20fcb  seerr.wrapper
"
