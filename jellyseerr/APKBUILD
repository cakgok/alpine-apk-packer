pkgname=jellyseerr
pkgver=2.7.3
pkgrel=0
pkgdesc="Plex/Emby/Jellyfin request management system (Next-Gen Overseerr fork)"
url="https://github.com/Fallenbagel/jellyseerr"
arch="x86_64"
license="MIT"
depends="nodejs npm sqlite-libs libc6-compat libgcc libstdc++ musl-utils gcompat"
makedepends="nodejs npm python3 make g++ pkgconfig gcompat"
subpackages="$pkgname-openrc::x86_64"
source="$pkgname-$pkgver.tar.gz::https://github.com/Fallenbagel/jellyseerr/archive/refs/tags/v$pkgver.tar.gz
        jellyseerr.initd
        jellyseerr.confd
       "
       
pkgusers="jellyseerr"
pkggroups="jellyseerr"
options="!check"

prepare() {
	default_prepare
	cd "$builddir"

	sed -i 's/"husky install"/"echo husky ignored"/' package.json
	sed -i '/"engines": {/,/},/d' package.json

	export NEXT_TELEMETRY_DISABLED=1
	export CYPRESS_INSTALL_BINARY=0
  export SHARP_IGNORE_GLOBAL_LIBVIPS=1

	npx pnpm@9 install --frozen-lockfile
}


build() {
    cd "$builddir"
    
    export NEXT_TELEMETRY_DISABLED=1
    export CYPRESS_INSTALL_BINARY=0
    export SHARP_IGNORE_GLOBAL_LIBVIPS=1
    
    npx pnpm@9 build
    npx pnpm@9 cache delete
}


package() {
	local app_dir="$pkgdir/usr/lib/$pkgname"

  install -dm755 "$pkgdir/usr/lib/jellyseerr"
  install -dm755 "$pkgdir/usr/bin"
  install -dm755 "$pkgdir/var/lib/jellyseerr"
  install -dm755 "$pkgdir/var/log/jellyseerr"

  cp -a .next dist public node_modules "$app_dir"/
  cp ./package.json ./jellyseerr-api.yml ./next.config.js "$app_dir/"

  rm -rf "$app_dir/.next/cache"
  cd "$app_dir" && npx pnpm@9 prune --prod

  echo "{\"commitTag\":\"v$pkgver\"}" > "$pkgdir/usr/lib/jellyseerr/committag.json"

  #wrapper
  cat > "$pkgdir/usr/bin/jellyseerr" <<-EOF
  #!/bin/sh
  cd /usr/lib/jellyseerr
  exec /usr/bin/node dist/index.js "$@"
EOF

  chmod +x "$pkgdir/usr/bin/jellyseerr"

  install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
  install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
88599a9ae20a54403f8082e115dd513b66466ec4a064f198316e5659dc00b2c5445381453cfa5f59edb48f046a07e7851d84cfe4501c9ce42cce5d91ae2de395  jellyseerr-2.7.3.tar.gz
5fc8c8d53fb6586093bb2339acc2e54d73163f663ffda17f3aa1082b7db6f7a6c7905fe9c0daaea7534918b10e99713e21748164bdf324f97fcaba793bee3bf1  jellyseerr.initd
9d5ebc45d18268bcec2d0ec48b9d86538f236d2ff8845b081691176cd0689bf6b521e244b0ce27fc3aefd569bfc7c2d4b8827d7cc4043bd9ffe8660d3bdce061  jellyseerr.confd
"
