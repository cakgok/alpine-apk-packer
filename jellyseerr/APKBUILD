pkgname=jellyseerr
pkgver=2.7.3
pkgrel=0
pkgdesc="Plex/Emby/Jellyfin request management system (Next-Gen Overseerr fork)"
url="https://github.com/Fallenbagel/jellyseerr"
arch="x86_64"
license="MIT"
depends="nodejs"
makedepends="nodejs npm git python3 make linux-headers"
subpackages="$pkgname-openrc::x86_64"
source="$pkgname-$pkgver.tar.gz::https://github.com/Fallenbagel/jellyseerr/archive/refs/tags/v$pkgver.tar.gz
        jellyseerr.initd
        jellyseerr.confd
        jellyseerr.wrapper
       "
       
pkgusers="jellyseerr"
pkggroups="jellyseerr"
options="!check !tracedeps"

build() {
    msg "Installing pnpm@9 locally..."
    cd "$srcdir"
    npm install --prefix "$srcdir/npm-tmp" pnpm@9
    export PATH="$srcdir/npm-tmp/node_modules/.bin:$PATH"

    cd "$builddir"
    CYPRESS_INSTALL_BINARY=0 pnpm install --frozen-lockfile
    pnpm build
}

# This is the final, recommended package() function
package() {
    local app_dir="$pkgdir/usr/lib/$pkgname"
    cd "$builddir"

    export PATH="$srcdir/npm-tmp/node_modules/.bin:$PATH"
    pnpm prune --prod --ignore-scripts

    install -dm755 "$app_dir"
    install -dm755 "$pkgdir/var/lib/jellyseerr"
    install -dm755 "$pkgdir/var/log/jellyseerr"
    install -dm755 "$pkgdir/etc/jellyseerr"

    cp -a .next dist public node_modules \
          package.json jellyseerr-api.yml next.config.js \
          "$app_dir/"

    # Remove caches, tests, and docs for size reduction.
    rm -rf "$app_dir/.next/cache"
    find "$app_dir/node_modules" -type d -name "test" -exec rm -rf {} +
    find "$app_dir/node_modules" -type d -name "docs" -exec rm -rf {} +
    find "$app_dir/node_modules" \
        \( -path '*/sharp/**' -o -path '*/ffmpeg-static/**' \) \
        ! -path '*linux-x64-musl*' -type f -delete
    find "$app_dir" -name '*.map' -type f -delete

    install -Dm755 "$srcdir/$pkgname.wrapper" "$pkgdir/usr/bin/jellyseerr"
    install -Dm755 "$srcdir/$pkgname.initd"   "$pkgdir/etc/init.d/$pkgname"
    install -Dm644 "$srcdir/$pkgname.confd"   "$pkgdir/etc/conf.d/$pkgname"
}

sha512sums="
88599a9ae20a54403f8082e115dd513b66466ec4a064f198316e5659dc00b2c5445381453cfa5f59edb48f046a07e7851d84cfe4501c9ce42cce5d91ae2de395  jellyseerr-2.7.3.tar.gz
e73b5f83092d0f014057672b31e5cdbe1a4b85c28ab4d965947c2b39470427d3c51dfbcf7a8bebd92b2afbaea69cb8030cab0c60ab1d7dcebaf9df6de36fb143  jellyseerr.initd
9d5ebc45d18268bcec2d0ec48b9d86538f236d2ff8845b081691176cd0689bf6b521e244b0ce27fc3aefd569bfc7c2d4b8827d7cc4043bd9ffe8660d3bdce061  jellyseerr.confd
20dd1613d2d4e3a3286e2779e5bfcb22f97d56f27e9ae9bd45791a9676cb4f9959e4f5a19ea73cc8fa055b5181ec778f97e723c995dfde049a11747e68e20fcb  jellyseerr.wrapper
"
