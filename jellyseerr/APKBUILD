pkgname=seerr
pkgver=2.7.3
pkgrel=0
pkgdesc="Plex/Emby/Jellyfin request management system (Next-Gen Overseerr fork)"
url="https://github.com/seerr-team/seerr"
arch="x86_64"
license="MIT"
depends="nodejs sqlite-libs vips"
makedepends="nodejs npm git python3 make linux-headers gcc g++ py3-setuptools vips-dev"
subpackages="$pkgname-openrc::x86_64"
source="$pkgname-$pkgver.tar.gz::https://github.com/seerr-team/seerr/archive/refs/tags/v$pkgver.tar.gz
        seerr.initd
        seerr.confd
        seerr.pre-install
        seerr.wrapper
       "
       
pkgusers="seerr"
pkggroups="seerr"   
options="!check !tracedeps"

build() {
    npm install --prefix "$srcdir/npm-tmp" pnpm@9
    export PATH="$srcdir/npm-tmp/node_modules/.bin:$PATH"

    cd "$builddir"
    sed -i 's/husky install//' package.json
    sed -i 's/"sharp":[^,]*/"sharp":"^0.34.4"/' package.json
    
    export NEXT_TELEMETRY_DISABLED=1
    export CYPRESS_INSTALL_BINARY=0
    export PNPM_CONFIG_UNSAFE_PERM=true
    export npm_config_build_from_source=true
    pnpm install --frozen-lockfile 
    pnpm build
    pnpm prune --prod --ignore-scripts

    rm -rf src server charts gen-docs docs .next/cache    
}

package() {
    local app_dir="$pkgdir/usr/lib/$pkgname"
    
    install -dm755 "$app_dir"
    install -dm755 "$pkgdir/var/lib/seerr"
    install -dm755 "$pkgdir/var/log/seerr"
    install -dm755 "$pkgdir/etc/seerr"

    cd "$builddir"
    cp -RL .next dist public node_modules \
           package.json jellyseerr-api.yml next.config.js \
           "$app_dir/"

    rm -rf "$app_dir/.next/cache"
    find "$app_dir" -name '*.map' -type f -delete
    
    install -Dm755 "$srcdir/$pkgname.wrapper" "$pkgdir/usr/bin/seerr"
    install -Dm755 "$srcdir/$pkgname.initd"   "$pkgdir/etc/init.d/$pkgname"
    install -Dm644 "$srcdir/$pkgname.confd"   "$pkgdir/etc/conf.d/$pkgname"
}

sha512sums="
d27d49fa11a7b30ec1693b23e23fe7a93613d901f99de6d24de658bb7fd2bc13db957ae1c0f98a1e0ef709b923736f65cecd2ae22144ffe26f1dbee1b830f5b2  seerr-2.7.3.tar.gz
9fcf1faf5513e9bcff5957ca11b131d697fcaa2a0e58d47fe7dea67ec8129451f855719bfb8a9e5e136bb9548274b3d09c5c45917df0320601d34a0fba8ddaee  seerr.initd
c2ff307e692e162f24c56b099401a1f8e5ffc75adea4a4014d47a0713b9e60b25ebbeb6cce1ed7aff8305020dc93e137c632adbb3473e84294036a5c5e6e371d  seerr.confd
b6fda90b71c3581095e9ec4e081e6e43d7bf2cb549454627a54dd8ff52a2a5eb0ad8a0d12791300f372dbcd11bf1a40d13b1034aa6b6d715aa32b875d15cf2e5  seerr.pre-install
737c326e7945fe8c2decdff79aff4338a0c7b577fd8d144437626baee4911d7574fd80c2550e2b7d9b942e7a868315443dd51b7552d1256c415338ccabadb7de  seerr.wrapper
"
