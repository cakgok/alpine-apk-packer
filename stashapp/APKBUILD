pkgname=stash
pkgver=0.29.0
pkgrel=0
pkgdesc="An organizer for your porn, written in Go"
url="https://github.com/stashapp/stash"
arch="x86_64"
license="AGPL-3.0-only"
depends="ca-certificates ffmpeg tzdata vips vips-tools"
makedepends="py3-pip python3"
options="!check !strip"

subpackages="$pkgname-openrc::x86_64 $pkgname-python::x86_64"

install="$pkgname.pre-install"
backup="etc/stash/config.yml" 

source="
	stash-linux::https://github.com/stashapp/stash/releases/download/v$pkgver/stash-linux
	stash.initd
	stash.confd
	"

pkgusers="stash"
pkggroups="stash" 

prepare() {
	default_prepare
}

build() {
	true
}

package() {
	install -dm755 "$pkgdir/var/lib/stash"
	install -dm755 "$pkgdir/var/log/stash"
	install -dm755 "$pkgdir/etc/stash"

	install -Dm755 "$srcdir"/stash-linux "$pkgdir"/usr/bin/stash
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

python() {
    pkgdesc="Python runtime and pip for $pkgname plugins"
	depends="python3 py3-pip py3-requests py3-requests-toolbelt py3-lxml py3-beautifulsoup4 py3-urllib3 py3-certifi py3-pyparsing"

	python3 -m pip install \
		--root="$subpkgdir" --prefix=/usr \
		--no-cache-dir \
		--disable-pip-version-check \
		--break-system-packages \
		mechanicalsoup cloudscraper stashapp-tools
}

sha512sums="
8c4e3c38b90db3a5217298c939bbb13bc62761e807a4148e9d7e50617e4985f0e9859c0985161625195cbb41011d90bf9b80dc99ecb589e88d4da5a92e643181  stash-linux
e32d97b55cc8cda7132d6a1f5669dbd505f7e0b70e35496182ffb32c4d3ced1f5908f83f8057cc0e60fbfe3d13a0593f70256d6ec1b3ba3a33dfcfe4ea27f7de  stash.initd
81f10dcd7c7d51296a37cb0b422c1843aba7bd5eae2dbcf461d6f026c309d03f8995e427bd00409aec1dfee463e2f16b1aafaef66e67a649537501b4ffa231b1  stash.confd
"
