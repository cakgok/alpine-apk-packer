pkgname=stash
pkgver=0.28.1
pkgrel=0
pkgdesc="An organizer for your porn, written in Go"
url="https://github.com/stashapp/stash"
arch="x86_64"
license="AGPL-3.0-only"
depends="ca-certificates ffmpeg tzdata vips vips-tools"
makedepends="py3-pip python3"
options="!check !strip"

subpackages="$pkgname-openrc::x86_64 $pkgname-python::x86_64"

install="$pkgname.pre-install"
backup="etc/stash/config.yml" 

source="
	stash-linux::https://github.com/stashapp/stash/releases/download/v$pkgver/stash-linux
	stash.initd
	stash.confd
	"

pkgusers="stash"
pkggroups="stash" 

prepare() {
	default_prepare
}

build() {
	true
}

package() {
	install -dm755 "$pkgdir/var/lib/stash"
	install -dm755 "$pkgdir/var/log/stash"
	install -dm755 "$pkgdir/etc/stash"

	install -Dm755 "$srcdir"/stash-linux "$pkgdir"/usr/bin/stash
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

python() {
    pkgdesc="Python runtime and pip for $pkgname plugins"
	depends="python3 py3-pip py3-requests py3-requests-toolbelt py3-lxml py3-beautifulsoup4 py3-urllib3 py3-certifi py3-pyparsing"

	export PYTHONUSERBASE="$subpkgdir/usr/lib/stash/python"
	install -dm755 "$PYTHONUSERBASE"
	python3 -m pip install --no-deps --no-cache-dir --disable-pip-version-check --user \
		mechanicalsoup cloudscraper stashapp-tools
	find "$PYTHONUSERBASE/bin" -type f -exec install -Dm755 {} "$subpkgdir/usr/bin/$(basename {})" \;
}

sha512sums="
c9c0d193859f03997c37270614771229d2cb1b8a9f536a7461d068d68425f2bcf8ae0674d8aa2a6a14a6380a7714c1f16c1c7fab3fdd41ff7a682fb70bf27918  stash-linux
9f6d1766bc8316b4b6e1540a74f8b6d6d2888ee08d95a1e29edfc24b6830e39713d0f5c162ddbb9a16146f6103f3638a11ce9202a2346124397c0f759f7f1cb4  stash.initd
81f10dcd7c7d51296a37cb0b422c1843aba7bd5eae2dbcf461d6f026c309d03f8995e427bd00409aec1dfee463e2f16b1aafaef66e67a649537501b4ffa231b1  stash.confd
"
