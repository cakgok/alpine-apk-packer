pkgname=bazarr
pkgver=1.5.3
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
    7zip 
    ffmpeg
    mediainfo
    python3
    py3-wheel
    py3-lxml
    py3-numpy
    py3-gevent
    py3-cryptography
    py3-setuptools
    py3-psycopg2
    py3-pillow
    "

makedepends="
    py3-pip
    gcc
    python3-dev
    musl-dev
    unzip
    "

options="!check"

pkgusers="bazarr"
pkggroups="bazarr"
subpackages="$pkgname-openrc::x86_64"

source="$pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip
  bazarr.initd
  bazarr.confd
"

prepare() {
    # Isolate the unpacked contents
    mkdir -p "$srcdir/unpacked"
    unzip -q "$srcdir/$pkgname-$pkgver.zip" -d "$srcdir/unpacked"
    # Find the actual root of the source code
    local _app_root="$srcdir/unpacked"
    cd "$_app_root"
    # Check if there's a nested zip
    set -- *
    if [ $# -eq 1 ] && [ -d "$1" ]; then
        _app_root="$_app_root/$1"
    fi
    # Create clean folder for the app src
    mkdir -p "$srcdir/app-source"
    # Copy only the app files into the dir
    cp -a "$_app_root/." "$srcdir/app-source/"
    # Clean up
    cd "$srcdir"
    rm -rf "$srcdir/unpacked"
}

build() {
    python3 -m pip download \
        --no-cache-dir --no-deps           \
        --only-binary=:all:                \
        --dest="$srcdir/wheelhouse"  \
        "webrtcvad-wheels>=2.0.14"
        # webrtcvad actually in edge/testing, consider moving it into depeneds
        # and get rid of 2-step pip install
}

package() {
    install -dm755 "$pkgdir/usr/lib/bazarr" 
    install -dm755 "$pkgdir/usr/bin"
    install -dm755 "$pkgdir/var/lib/bazarr"

    cp -a "$srcdir/app-source"/. "$pkgdir/usr/lib/bazarr/"
    pip install \
        --break-system-packages \
        --no-deps --no-cache-dir --no-index \
        --find-links="$srcdir/wheelhouse" \
        --root="$pkgdir" --prefix=/usr \
        "webrtcvad-wheels>=2.0.10"

    cat > "$pkgdir/usr/bin/bazarr" <<-EOF
		#!/bin/sh
		# Wrapper script to launch bazarr from /usr/bin
		cd /usr/lib/bazarr
		exec /usr/bin/python3 bazarr.py "\$@"
	EOF

    install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
7ec1366a94a26722b5b4bb17d33600a3f96379bbaad9a4a0337a98be11d9f5ed95b635be1bee2eee3c4e4455ca3d02497018f4579074ec91163836af2db42dbd  bazarr-1.5.3.zip
6fe5d1e992a6a356d5b5df9640207935d679b8849a359f45a5f9e9dbfc294d4e490352a872efb48bac92455162361568022035058d5dae1e0eea66be436d89e7  bazarr.initd
6c2d58a03406bd09957c084bf42262778b5553b5986b41eef250b48b175fe30fe225bf3a7163ccdba4b400686ac02dd4995145fac704b28af760300caf133f4b  bazarr.confd
"
