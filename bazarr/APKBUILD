pkgname=bazarr
pkgver=1.5.5
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
    7zip 
    ffmpeg
    mediainfo
    python3
    py3-wheel
    py3-lxml
    py3-numpy
    py3-gevent
    py3-cryptography
    py3-setuptools
    py3-psycopg2
    py3-pillow
    "

makedepends="
    py3-pip
    gcc
    python3-dev
    musl-dev
    unzip
    "

options="!check"

pkgusers="bazarr"
pkggroups="bazarr"
subpackages="$pkgname-openrc::x86_64"
install="$pkgname.pre-install"

source="$pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip
  bazarr.initd
  bazarr.confd
  bazarr.wrapper
"

prepare() {
    # Isolate the unpacked contents
    mkdir -p "$srcdir/unpacked"
    unzip -q "$srcdir/$pkgname-$pkgver.zip" -d "$srcdir/unpacked"
    # Find the actual root of the source code
    local _app_root="$srcdir/unpacked"
    cd "$_app_root"
    # Check if there's a nested zip
    set -- *
    if [ $# -eq 1 ] && [ -d "$1" ]; then
        _app_root="$_app_root/$1"
    fi
    # Create clean folder for the app src
    mkdir -p "$srcdir/app-source"
    # Copy only the app files into the dir
    cp -a "$_app_root/." "$srcdir/app-source/"
    # Clean up
    cd "$srcdir"
    rm -rf "$srcdir/unpacked"
}

build() {
    python3 -m pip download \
        --no-cache-dir --no-deps           \
        --only-binary=:all:                \
        --dest="$srcdir/wheelhouse"  \
        "webrtcvad-wheels>=2.0.14"
        # webrtcvad actually in edge/testing, consider moving it into depeneds
        # and get rid of 2-step pip install
}

package() {
    install -dm755 "$pkgdir/usr/lib/bazarr"
    install -dm755 "$pkgdir/usr/bin"
    install -dm755 "$pkgdir/var/lib/bazarr"
    
    cp -a "$srcdir/app-source"/. "$pkgdir/usr/lib/bazarr/"
    
    pip install \
        --break-system-packages \
        --no-deps --no-cache-dir --no-index \
        --find-links="$srcdir/wheelhouse" \
        --root="$pkgdir" --prefix=/usr \
        "webrtcvad-wheels>=2.0.10"
        
    install -Dm755 "$srcdir"/$pkgname.wrapper "$pkgdir"/usr/bin/$pkgname
    install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
    install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
67186f0555889b5acfa2e86c705b5dbb89b0e41d16123b31b57057dc842b7aed99cd3980bb7f35e4b410c3c761fe73040e0cd13ed0c5f4abaf9f9ce3d103a60c  bazarr-1.5.5.zip
305433856c34303db99e860116a38271791aed924afd109e8bddd46e70d522dce8ef01ea79f83fd8adc5e5b99725c753a33193d7820567d77d442054052fb31c  bazarr.initd
6c2d58a03406bd09957c084bf42262778b5553b5986b41eef250b48b175fe30fe225bf3a7163ccdba4b400686ac02dd4995145fac704b28af760300caf133f4b  bazarr.confd
c6dae197f1eab4c01742a361e0849f5a695589b1d31688255195e08c1376f309cd3bce14c54ebda1f06e61cbe241753c0c2117156f0308673845c355f3224ef3  bazarr.wrapper
"
